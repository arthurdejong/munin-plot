<!DOCTYPE html>
<html lang="en">
<head>
</head>
<body>

  <div id="plot1" class="myplot" style="width:90%;height:250px;"></div>
  <div id="plot2" class="myplot" style="width:90%;height:250px;"></div>
  <div id="plot3" class="myplot" style="width:90%;height:250px;"></div>

  <script type="text/javascript" src="js/plotly-1.41.0.min.js"></script>
<script type="text/javascript">

  var default_colors = [
    '#00cc00', '#0066b3', '#ff8000', '#ffcc00', '#330099', '#990099',
    '#ccff00', '#ff0000', '#808080', '#008f00', '#00487d', '#b35a00',
    '#b38f00', '#6b006b', '#8fb300', '#b30000', '#bebebe', '#80ff80',
    '#80c9ff', '#ffc080', '#ffe680', '#aa80ff', '#ee00cc', '#ff8080',
    '#666600', '#ffbfff', '#00ffcc', '#cc6699', '#999900'];

  var layout = {
    margin: { l: 48, t: 0, r: 32, b: 32 },
    autosize: true,
    showlegend: true,
    dragmode: 'zoom',
    selectdirection: 'h',
    xaxis: {
      tickfont: {
        size: 10,
        color: '#7f7f7f'
      }
    },
    yaxis: {
      fixedrange: true,
      tickfont: {
        size: 10,
        color: '#7f7f7f'
      }
    },
    legend: {
      bgcolor: '#ffffffa0',
      xanchor: 'auto',
      x: 1.2
    }
  };

  var config = {
    showLink: false,
    displaylogo: false,
    autosizable: true,
    responsive: true,
    scrollZoom: true,
    displayModeBar: false,
    modeBarButtonsToRemove: [
      'sendDataToCloud',
      'toImage',
      'lasso2d',
      'resetScale2d',
      'hoverClosestCartesian',
      'hoverCompareCartesian'
    ]
    // toImageButtonOptions
  }

  Plotly.plot('plot1', [], JSON.parse(JSON.stringify(layout)), config);
  Plotly.plot('plot2', [], JSON.parse(JSON.stringify(layout)), config);
  Plotly.plot('plot3', [], JSON.parse(JSON.stringify(layout)), config);

  var plots = document.getElementsByClassName('myplot');

  // make zoom levels consistent across graphs
  [].forEach.call(plots, plot => {
    plot.on('plotly_relayout', function(ed) {
      [].forEach.call(plots, (plot, i) => {
        let xaxis = plot.layout.xaxis;
        if ((ed['xaxis.range[0]'] && xaxis.range[0] != ed['xaxis.range[0]']) ||
            (ed['xaxis.range[1]'] && xaxis.range[1] != ed['xaxis.range[1]']) ||
            (ed['xaxis.autorange'] && ed['xaxis.autorange'] != xaxis.autorange))
          Plotly.relayout(plot, ed);
      });
    });
  });

  // load graph data into the plot
  function loadGraph(plot, graph) {
    var traces = [];
    var tracebyfield = {};
    var stackgroup = 0;
    // prepare the graph configuration
    for (var i = 0; i < graph.fields.length; i++) {
      var field = graph.fields[i];
      var color = field.colour ? '#' + field.colour : default_colors[i];
      if (field.draw == 'AREA' || field.draw == 'STACK' || field.draw == 'AREASTACK') {
        if (!field.draw.match(/STACK/) && graph.fields[i + 1].draw.match(/STACK/)) {
          stackgroup += 1;
        }
        var trace = {
          name: field.label || field.name,
          x: [],
          y: [],
          line: {width: 0},
          fillcolor: color + 'c0',
          hoverlabel: {bgcolor: color + 'c0'},
          stackgroup: 'stack' + stackgroup
        };
        traces.push(trace);
        tracebyfield[field.name] = trace;
      } else {
        var trace = {
          name: field.label || field.name,
          x: [],
          y: [],
          line: {color: color}
        };
        var trace_min = {
          x: [],
          y: [],
          showlegend: false,
          hoverinfo: 'skip',
          line: {width: 0}
        };
        var trace_max = {
          x: [],
          y: [],
          showlegend: false,
          hoverinfo: 'skip',
          line: {width: 0},
          fill: 'tonexty',
          fillcolor: color + '20'
        };
        traces.push(trace, trace_min, trace_max);
        tracebyfield[field.name] = trace;
        tracebyfield[field.name + '.min'] = trace_min;
        tracebyfield[field.name + '.max'] = trace_max;
      }
    }
    // fetch the data and plot it
    Plotly.d3.csv('data/' + graph.name, function(data) {
      for (var i = 0; i < data.length; i++) {
        row = data[i];
        time = row['time'];
        Object.keys(tracebyfield).forEach(function(field) {
          tracebyfield[field].x.push(time);
          tracebyfield[field].y.push(Number(row[field]));
        });
      }
      Plotly.react(plot, traces, JSON.parse(JSON.stringify(layout)), config);
    });
  }

  // load all graphs
  var request = new XMLHttpRequest();
  request.overrideMimeType('application/json');
  request.open('GET', 'graphs', true);
  request.onreadystatechange = function () {
    if (request.readyState == 4 && request.status == '200') {
      var graphs = JSON.parse(request.responseText);
      loadGraph('plot1', graphs['some.group/host.some.group/cpu']);
      loadGraph('plot2', graphs['some.group/host.some.group/if_inet0']);
      loadGraph('plot3', graphs['some.group/host.some.group/iostat_ios']);
    }
  };
  request.send(null);

</script>
</body>
</html>
