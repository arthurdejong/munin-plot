<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <title>Graphs</title>
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/open-iconic-bootstrap.min.css" type="text/css" rel="stylesheet">
  <style type="text/css">
    #draggablelist .draghandle {
      cursor: move;
    }
    #draggablelist .card {
      margin: 1em 0;
    }
    .card-leftheader {
      width: 48px;
      font-size: 18px;
      line-height: 2em;
      text-align: center;
      padding: 10px 15px;
      margin-bottom: 0;
      background-color: rgba(0,0,0,.03);
      border-right: 1px solid rgba(0,0,0,.125);
      float: left;
      height: 100%;
      position: absolute;
    }
    .card-rightbody {
      margin-left: 45px;
      padding: 5px;
      float: left;
      height: 100%;
      padding-right: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="row">
      <div class="col-md-12">

        <ul id="draggablelist" class="list-unstyled">

          <li class="card">
            <div class="card-leftheader">
              <span class="oi oi-move draghandle"></span>
            </div>
            <div class="card-rightbody">
              <div id="plot1" class="myplot" style="width:100%;height:250px;"></div>
            </div>
          </li>

          <li class="card">
            <div class="card-leftheader">
              <span class="oi oi-move draghandle"></span>
            </div>
            <div class="card-rightbody">
              <div id="plot2" class="myplot" style="width:100%;height:250px;"></div>
            </div>
          </li>

          <li class="card">
            <div class="card-leftheader">
              <span class="oi oi-move draghandle"></span>
            </div>
            <div class="card-rightbody">
              <div id="plot3" class="myplot" style="width:100%;height:250px;"></div>
            </div>
          </li>

        </ul>

      </div>
    </div>
  </div>
  <script type="text/javascript" src="js/jquery-2.2.4.min.js"></script>
  <script type="text/javascript" src="js/jquery-ui-1.12.1.min.js"></script>
  <script type="text/javascript" src="js/popper.min.js"></script>
  <script type="text/javascript" src="js/bootstrap.min.js"></script>
  <script type="text/javascript" src="js/plotly-1.41.0.min.js"></script>
<script type="text/javascript">

  $(document).ready(function() {
    jQuery(function($) {
      var panelList = $('#draggablelist');
      panelList.sortable({
        handle: '.draghandle',
        update: function() {
          $('.panel', panelList).each(function(index, elem) {
            var $listItem = $(elem), newIndex = $listItem.index();
          });
        }
      });
    });
  });
  var default_colors = [
    '#00cc00', '#0066b3', '#ff8000', '#ffcc00', '#330099', '#990099',
    '#ccff00', '#ff0000', '#808080', '#008f00', '#00487d', '#b35a00',
    '#b38f00', '#6b006b', '#8fb300', '#b30000', '#bebebe', '#80ff80',
    '#80c9ff', '#ffc080', '#ffe680', '#aa80ff', '#ee00cc', '#ff8080',
    '#666600', '#ffbfff', '#00ffcc', '#cc6699', '#999900'];

  var base_layout = {
    margin: { l: 48, t: 0, r: 32, b: 32 },
    autosize: true,
    showlegend: true,
    dragmode: 'zoom',
    selectdirection: 'h',
    xaxis: {
      tickfont: {
        size: 10,
        color: '#7f7f7f'
      }
    },
    yaxis: {
      fixedrange: true,
      tickfont: {
        size: 10,
        color: '#7f7f7f'
      },
      titlefont: {
        size: 10,
        color: '#7f7f7f'
      },
      exponentformat: 'SI'
    },
    legend: {
      bgcolor: '#ffffffa0',
      xanchor: 'auto',
      x: 1.2
    }
  };

  var config = {
    showLink: false,
    displaylogo: false,
    autosizable: true,
    responsive: true,
    scrollZoom: true,
    displayModeBar: false,
    modeBarButtonsToRemove: [
      'sendDataToCloud',
      'toImage',
      'lasso2d',
      'resetScale2d',
      'hoverClosestCartesian',
      'hoverCompareCartesian'
    ]
    // toImageButtonOptions
  }

  Plotly.plot('plot1', [], JSON.parse(JSON.stringify(base_layout)), config);
  Plotly.plot('plot2', [], JSON.parse(JSON.stringify(base_layout)), config);
  Plotly.plot('plot3', [], JSON.parse(JSON.stringify(base_layout)), config);

  var plots = document.getElementsByClassName('myplot');

  // make zoom levels consistent across graphs
  [].forEach.call(plots, plot => {
    plot.on('plotly_relayout', function(ed) {
      [].forEach.call(plots, (plot, i) => {
        let xaxis = plot.layout.xaxis;
        if ((ed['xaxis.range[0]'] && xaxis.range[0] != ed['xaxis.range[0]']) ||
            (ed['xaxis.range[1]'] && xaxis.range[1] != ed['xaxis.range[1]']) ||
            (ed['xaxis.autorange'] && ed['xaxis.autorange'] != xaxis.autorange))
          Plotly.relayout(plot, ed);
      });
    });
  });

  // load graph data into the plot
  function loadGraph(plot, graph) {
    var traces = [];
    var tracebyfield = {};
    var stackgroup = 0;
    // prepare the graph configuration
    var layout = JSON.parse(JSON.stringify(base_layout));
    if (graph.graph_vlabel)
      layout.yaxis.title = graph.graph_vlabel;
    if (graph.graph_args && graph.graph_args.match(/--logarithmic/)) {
      layout.yaxis.type = 'log';
      layout.yaxis.exponentformat = 'E';
    }
    // prepare the data series configuration
    for (var i = 0; i < graph.fields.length; i++) {
      var field = graph.fields[i];
      var color = field.colour ? '#' + field.colour : default_colors[i];
      if (field.draw == 'AREA' || field.draw == 'STACK' || field.draw == 'AREASTACK') {
        if (!field.draw.match(/STACK/) && graph.fields[i + 1].draw.match(/STACK/)) {
          stackgroup += 1;
        }
        var trace = {
          name: field.label || field.name,
          x: [],
          y: [],
          line: {width: 0},
          fillcolor: color + 'c0',
          hoverlabel: {bgcolor: color + 'c0'},
          stackgroup: 'stack' + stackgroup
        };
        traces.push(trace);
        tracebyfield[field.name] = trace;
      } else {
        var trace = {
          name: field.label || field.name,
          x: [],
          y: [],
          line: {color: color}
        };
        var trace_min = {
          x: [],
          y: [],
          showlegend: false,
          hoverinfo: 'skip',
          line: {width: 0}
        };
        var trace_max = {
          x: [],
          y: [],
          showlegend: false,
          hoverinfo: 'skip',
          line: {width: 0},
          fill: 'tonexty',
          fillcolor: color + '20'
        };
        traces.push(trace, trace_min, trace_max);
        tracebyfield[field.name] = trace;
        tracebyfield[field.name + '.min'] = trace_min;
        tracebyfield[field.name + '.max'] = trace_max;
      }
    }
    // fetch the data and plot it
    Plotly.d3.csv('data/' + graph.name, function(data) {
      for (var i = 0; i < data.length; i++) {
        row = data[i];
        time = row['time'];
        Object.keys(tracebyfield).forEach(function(field) {
          tracebyfield[field].x.push(time);
          tracebyfield[field].y.push(Number(row[field]));
        });
      }
      Plotly.react(plot, traces, layout, config);
    });
  }

  // load all graphs
  var request = new XMLHttpRequest();
  request.overrideMimeType('application/json');
  request.open('GET', 'graphs', true);
  request.onreadystatechange = function () {
    if (request.readyState == 4 && request.status == '200') {
      var graphs = JSON.parse(request.responseText);
      loadGraph('plot1', graphs['some.group/host.some.group/cpu']);
      loadGraph('plot2', graphs['some.group/host.some.group/if_inet0']);
      loadGraph('plot3', graphs['some.group/host.some.group/iostat_ios']);
    }
  };
  request.send(null);

</script>
</body>
</html>
